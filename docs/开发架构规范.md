# 开发架构规范（v1）

## 设计目标
- 保持分层清晰、依赖方向单一，降低耦合与认知成本
- 面向用例开发（Use Case），便于测试与替换适配器
- 可在内存与 PostgreSQL 间平滑切换存储实现
- 集成外部能力与支付系统时保持边界与契约稳定

## 分层架构
- Server（接口适配层）
  - 负责 HTTP 路由、入参校验、序列化/反序列化、错误码输出与 CORS
  - 不承载业务流程与数据持久化逻辑
- Usecase（应用层）
  - 编排领域流程，调用仓库/适配器实现完整用例
  - 定义边界：输入参数、返回值与状态转换
- Domain（领域层）
  - 领域模型与状态枚举（例如 Task.Status、Order.Status）
  - 不依赖具体技术栈
- Infrastructure（基础设施层）
  - 适配器实现：仓库（内存/Postgres）、资产写入（FS）、ZJZ 客户端、支付客户端
  - 面向接口的具体实现，可替换
- Config/Env（配置）
  - 统一读取环境变量与命令行参数，供 Server 初始化依赖
- CMD（启动入口）
  - 进程启动、目录准备、HTTP 服务监听

## 目录结构
- cmd/permit-backend/main.go（启动入口）
- internal/
  - server/server.go（HTTP 路由与适配）
  - usecase/
    - task_service.go（任务用例）
    - order_service.go（订单用例）
  - domain/
    - task.go（任务模型与状态）
    - order.go（订单模型与状态）
  - infrastructure/
    - repo/
      - memory.go（内存实现：TaskRepo/OrderRepo）
      - postgres.go（Postgres 实现：Task 与 Order）
    - asset/
      - writer.go（文件系统资产写入）
  - config/config.go（配置结构与环境变量映射）
  - env/env.go（.env 加载器）

## 依赖注入与选择策略
- 在 server.New 中根据配置初始化依赖：
  - 当 POSTGRES_DSN 不为空时启用 Postgres 仓库，否则使用内存仓库
  - 资产写入使用文件系统适配器（FSWriter）
  - ZJZ 使用客户端适配器调用第三方接口
- 配置来源
  - .env/.env.local 加载（env.Load）
  - 命令行参数覆盖（flag）
  - 环境变量键名：
    - PERMIT_ENV、PERMIT_PORT、PERMIT_ASSETS_DIR、PERMIT_UPLOADS_DIR
    - PERMIT_JWT_SECRET、PERMIT_LOG_JSON、PERMIT_ZJZ_BASE_URL、PERMIT_ZJZ_KEY、PERMIT_ZJZ_ACCESS_TOKEN、PERMIT_ZJZ_WATERMARK
    - PERMIT_PAY_MOCK、PERMIT_WECHAT_APPID、PERMIT_WECHAT_MCHID、PERMIT_WECHAT_NOTIFY_URL
    - POSTGRES_DSN

## 业务边界与数据流
- 任务创建（POST /api/tasks）
  - Server 接收参数 → TaskService.CreateTask
  - 用例调用 ZJZ 生成证件照与背景 → 写入资产（FSWriter）→ 写入 TaskRepo（状态与 URL）
- 任务查询/下载信息
  - Server 读取 TaskRepo 状态与 URL，下载信息仅在任务完成时返回
- 订单创建/查询/支付/回调
  - Server 调用 OrderService：
    - Create：校验任务存在，写入仓库与初始状态
    - Pay：生成微信 JSAPI v3 风格参数（mock），并更新待支付状态
    - Callback：根据回调 status 更新订单状态

## 仓库接口约定
- TaskRepo
  - Put(*domain.Task) error
  - Get(id string) (*domain.Task, bool)
- OrderRepo
  - Put(*domain.Order) error
  - Get(id string) (*domain.Order, bool)
  - List(page, pageSize int) ([]domain.Order, int)
- Postgres 适配器
  - 初始化自动建表（tasks、orders），上线建议使用迁移工具替代自动建表

## ZJZ 与支付集成
- ZJZ（第三方接口）
  - 由 server 层代理转发（/api/zjz/*）
  - 业务侧仅依赖 ZJZ 客户端的稳定返回结构
- 微信支付（mock）
  - 返回参数包含 appId、timeStamp、nonceStr、package（prepay_id=...）、signType（RSA）、paySign
  - 真正接入需替换为商户证书签名、回调验签与订单查询

## API 约定
- 任务
  - POST /api/tasks：创建任务
  - GET /api/tasks/{id}：查询任务
  - GET /api/download/{id}：任务完成后返回下载 URL
- 订单
  - POST /api/orders：创建订单（必须关联 taskId）
  - GET /api/orders：分页查询（page/pageSize，默认 1/20）
  - GET /api/orders/{id}：订单详情
  - POST /api/pay/wechat：返回微信支付参数（mock）
  - POST /api/pay/callback：更新订单状态
- 错误响应
  - 统一为 {"error":{"code","message","requestId"}}
- CORS
  - 允许 GET/POST/OPTIONS；允许所有头与来源（开发模式）

## 开发规范
- 命名
  - 包名小写、短名；文件名与职责一致；类型名清晰表达模型/用例
- 错误处理
  - 不 panic；服务层失败需落库状态（失败）与错误信息；接口层返回标准错误码与消息
- 并发与锁
  - 内存仓库使用 RWMutex；Postgres 交由数据库事务处理
- 时间
  - 统一使用 UTC 存储
- JSON
  - 保持 API 字段与前端约定一致，避免破坏兼容性
- 配置
  - 所有可变参数通过环境变量与 flag 注入，不在代码中硬编码
- 资产存储
  - /assets/<taskId>/<color>.jpg
- 分页参数
  - page/pageSize；默认 1/20；总数 total 一并返回

## 测试与运行
- 前置
  - 需要配置 ZJZ 相关环境变量（BaseURL/Key/AccessToken）
  - 如使用 Postgres，设置 POSTGRES_DSN 并确保库可连
- 编译与依赖
  - go build ./...
  - 依赖管理：变更后执行 go mod tidy
- 运行
  - go run ./cmd/permit-backend 或构建后执行二进制

## Docker 一键启动
- 通过 docker compose 启动后端 + PostgreSQL
  - 启动：`docker compose up -d`
  - 查看状态：`docker compose ps`
  - 查看日志：`docker compose logs -f backend`
  - 停止：`docker compose down`
- 默认端口
  - 后端：5000
  - PostgreSQL：5432
- 关键环境变量
  - PERMIT_ZJZ_BASE_URL=https://api.zjzapi.com
  - PERMIT_ZJZ_KEY=your_key
  - PERMIT_ZJZ_ACCESS_TOKEN=your_access_token
  - POSTGRES_DSN=postgres://postgres:postgres@postgres:5432/permit?sslmode=disable

## 引入新功能的步骤
- 在 domain 定义模型/状态
- 在 usecase 添加服务方法（编排依赖）
- 在 infrastructure 提供适配器实现（仓库/外部系统）
- 在 server 注册路由并调用 usecase 服务
- 在 config/Env 增加配置项与加载逻辑
- 补充测试与示例请求

## 数据库规范
- 开发模式使用自动建表；生产建议引入迁移工具（例如 goose/tern），避免运行时建表
- DSN 示例：postgres://user:pass@127.0.0.1:5432/permit?sslmode=disable

## 安全规范
- 不记录敏感信息与凭证；秘钥通过环境变量传入
- 日志可选择 JSON 格式（PERMIT_LOG_JSON）

## 关键代码参考
- Server 层：[server.go](file:///d:/dev/one-permit/permit-backend/internal/server/server.go)
- 用例层：[task_service.go](file:///d:/dev/one-permit/permit-backend/internal/usecase/task_service.go)、[order_service.go](file:///d:/dev/one-permit/permit-backend/internal/usecase/order_service.go)
- 领域层：[task.go](file:///d:/dev/one-permit/permit-backend/internal/domain/task.go)、[order.go](file:///d:/dev/one-permit/permit-backend/internal/domain/order.go)
- 仓库实现：[memory.go](file:///d:/dev/one-permit/permit-backend/internal/infrastructure/repo/memory.go)、[postgres.go](file:///d:/dev/one-permit/permit-backend/internal/infrastructure/repo/postgres.go)
- 资产写入：[writer.go](file:///d:/dev/one-permit/permit-backend/internal/infrastructure/asset/writer.go)
- ZJZ 客户端：[client.go](file:///d:/dev/my-project/one-permit/permit-backend/internal/infrastructure/zjzapi/client.go)
- 配置与入口：[config.go](file:///d:/dev/one-permit/permit-backend/internal/config/config.go)、[main.go](file:///d:/dev/one-permit/permit-backend/cmd/permit-backend/main.go)
