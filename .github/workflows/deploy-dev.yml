name: deploy
on:
  push:
    branches:
      - dev
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - run: go mod download
      - run: go vet ./...
      - run: go test ./... -v
      - run: docker build -t permit-backend:ci .
      - name: set-tag
        shell: bash
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [ "$BRANCH" = "main" ]; then
            echo "IMAGE_TAG=prod" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=dev" >> $GITHUB_ENV
          fi
      - name: resolve-acr-image
        shell: bash
        run: |
          set -euo pipefail
          ACR_REG="${{ secrets.ACR_REGISTRY }}"
          ACR_REPO="${{ secrets.ACR_REPO }}"
          if [[ -z "$ACR_REG" || -z "$ACR_REPO" ]]; then
            echo "You must set ACR_REGISTRY and ACR_REPO in Secrets" && exit 1
          fi
          if [[ "$ACR_REG" != *.cr.aliyuncs.com ]]; then
            echo "ACR_REGISTRY must end with .cr.aliyuncs.com" && exit 1
          fi
          if [[ "$ACR_REPO" != */* ]]; then
            echo "ACR_REPO must be <namespace>/<repo>, e.g. lovelykind/permit" && exit 1
          fi
          ACR_ALGO_IMAGE="${{ secrets.ACR_ALGO_IMAGE }}"
          ACR_POSTGRES_IMAGE="${{ secrets.ACR_POSTGRES_IMAGE }}"
          if [[ -z "$ACR_ALGO_IMAGE" || -z "$ACR_POSTGRES_IMAGE" ]]; then
            echo "You must set ACR_ALGO_IMAGE and ACR_POSTGRES_IMAGE in Secrets" && exit 1
          fi
          SRC_ALGO="${{ secrets.SOURCE_ALGO_IMAGE }}"
          SRC_PG="${{ secrets.SOURCE_POSTGRES_IMAGE }}"
          if [[ -z "$SRC_ALGO" ]]; then SRC_ALGO="linzeyi/hivision_idphotos:latest"; fi
          if [[ -z "$SRC_PG" ]]; then SRC_PG="postgres:16"; fi
          SYNC_DEPS="${{ secrets.SYNC_DEPS }}"
          if [[ -z "$SYNC_DEPS" ]]; then SYNC_DEPS="true"; fi
          echo "ACR_REGISTRY=$ACR_REG" >> $GITHUB_ENV
          echo "ACR_REPO=$ACR_REPO" >> $GITHUB_ENV
          echo "IMAGE_FULL=$ACR_REG/$ACR_REPO:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          echo "ALGO_IMAGE=$ACR_ALGO_IMAGE" >> $GITHUB_ENV
          echo "POSTGRES_IMAGE=$ACR_POSTGRES_IMAGE" >> $GITHUB_ENV
          echo "SOURCE_ALGO_IMAGE=$SRC_ALGO" >> $GITHUB_ENV
          echo "SOURCE_POSTGRES_IMAGE=$SRC_PG" >> $GITHUB_ENV
          echo "SYNC_DEPS=$SYNC_DEPS" >> $GITHUB_ENV
          echo "Resolved via ACR_REGISTRY/ACR_REPO: $ACR_REG/$ACR_REPO:${{ env.IMAGE_TAG }}"
      - name: login-acr
        run: echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_REGISTRY }} -u "${{ secrets.ACR_USERNAME }}" --password-stdin
      - name: sync-deps-images
        if: ${{ env.SYNC_DEPS == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          sync_image() {
            local src="$1"
            local dst="$2"
            if [[ "$dst" == *".cr.aliyuncs.com/"* ]]; then
              if docker manifest inspect "$dst" >/dev/null 2>&1; then
                echo "Skip sync, already exists: $dst"
                return
              fi
              echo "Sync $src -> $dst"
              docker pull "$src"
              docker tag "$src" "$dst"
              docker push "$dst"
            else
              echo "Skip sync for $dst"
            fi
          }
          sync_image "${{ env.SOURCE_ALGO_IMAGE }}" "${{ env.ALGO_IMAGE }}"
          sync_image "${{ env.SOURCE_POSTGRES_IMAGE }}" "${{ env.POSTGRES_IMAGE }}"
      - name: push-image
        run: |
          docker tag permit-backend:ci "${{ env.IMAGE_FULL }}"
          docker push "${{ env.IMAGE_FULL }}"
      - name: upload-compose
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_KEY }}
          source: "docker-compose.yml"
          target: "/srv/permit/"
          overwrite: true
      - name: deploy-ecs
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_KEY }}
          script: |
            docker login ${{ env.ACR_REGISTRY }} -u "${{ secrets.ACR_USERNAME }}" -p "${{ secrets.ACR_PASSWORD }}"
            mkdir -p /srv/permit
            cat >/srv/permit/.env <<EOF
            PERMIT_WECHAT_APPID=${{ secrets.PERMIT_WECHAT_APPID }}
            PERMIT_WECHAT_SECRET=${{ secrets.PERMIT_WECHAT_SECRET }}
            EOF
            cd /srv/permit
            export PERMIT_BACKEND_IMAGE=${{ env.IMAGE_FULL }}
            export PERMIT_ALGO_IMAGE=${{ env.ALGO_IMAGE }}
            export PERMIT_POSTGRES_IMAGE=${{ env.POSTGRES_IMAGE }}
            if docker compose version >/dev/null 2>&1; then
              docker compose pull
              docker compose up -d
              docker compose ps
            else
              docker-compose pull || true
              docker-compose up -d || true
              docker-compose ps || true
            fi
