# 接口文档（前端最终版）

## 1. 通用说明
- Base URL：`http://{host}:{port}`
- Header：
  - 需要登录的接口：`Authorization: Bearer <token>`
  - `Content-Type: application/json`（除上传/回调外）
- 统一错误响应：
```json
{"error":{"code":"BadRequest","message":"...","requestId":"..."}}
```

## 2. 免登录接口
- `POST /api/login`
- `GET /api/download/file`
- `POST /api/zjz/receipt/notify`
- `POST /api/zjz/ai-photo/notify`
- `POST /api/pay/wechat/notify`

## 3. 认证
### 3.1 登录
- `POST /api/login`
- 请求：
```json
{"code":"wx_login_code"}
```
- 响应：
```json
{"token":"...","userId":"...","openid":"..."}
```

## 4. 用户
### 4.1 当前用户
- `GET /api/me`
- Header：`Authorization: Bearer <token>`
- 响应（用户已存在时）：
```json
{"userId":"...","openid":"...","nickname":"...","avatar":"...","createdAt":"...","updatedAt":"..."}
```
- 响应（用户未落库时）：
```json
{"userId":"...","openid":"...","nickname":"","avatar":""}
```

## 5. 规格
### 5.1 规格列表
- `GET /api/specs`
- Query（可选）：`q` 或 `query`
- 响应：
```json
[
  {"code":"passport","name":"护照","widthPx":390,"heightPx":567,"dpi":300,"bgColors":["white","blue"]}
]
```

### 5.2 更新规格（仅 PostgreSQL）
- `POST /api/specs`
- 请求（数组）：
```json
[
  {"code":"passport","name":"护照","widthPx":390,"heightPx":567,"dpi":300,"bgColors":["white","blue"]}
]
```
- 响应：
```json
{"updated":1}
```

## 6. 上传
### 6.1 上传文件
- `POST /api/upload`
- 请求：`multipart/form-data`
  - 字段：`file`（jpg/png）
- 响应：
```json
{"objectKey":"uploads/xxx.jpg"}
```

## 7. 任务（证件照）
### 7.1 创建任务
- `POST /api/tasks`
- 请求：
```json
{
  "specCode": "passport",
  "itemId": 1,
  "sourceObjectKey": "uploads/xxx.jpg",
  "defaultBackground": "white",
  "availableColors": ["white","blue"],
  "colors": ["white","blue"],
  "widthPx": 390,
  "heightPx": 567,
  "dpi": 300,
  "beauty": 0,
  "enhance": 0,
  "watermark": false
}
```
- 说明：
  - `itemId` 优先使用；未传时后端会尝试用 `specCode` 自动匹配 ZJZ item。
  - `availableColors` 为空则取 `colors`，再为空取 `spec.bgColors`。
- 响应（Task）：
```json
{
  "id":"...",
  "userId":"...",
  "specCode":"passport",
  "spec":{"code":"passport","widthPx":390,"heightPx":567,"dpi":300},
  "itemId":1,
  "watermark":false,
  "beauty":0,
  "enhance":0,
  "sourceObjectKey":"uploads/xxx.jpg",
  "status":"done",
  "baselineUrl":"https://.../assets/<taskId>/white.jpg",
  "availableColors":["white","blue"],
  "processedUrls":{"white":"...","blue":"..."},
  "layoutUrls":{"6inch":"..."},
  "errorMsg":"",
  "createdAt":"...",
  "updatedAt":"..."
}
```

### 7.2 查询任务
- `GET /api/tasks/{id}`
- 响应：Task

### 7.3 补充背景色
- `POST /api/tasks/{id}/background`
- 请求：
```json
{"color":"blue","dpi":300}
```
- 响应：
```json
{"taskId":"...","color":"blue","url":"...","status":"done"}
```

### 7.4 生成六寸排版照
- `POST /api/tasks/{id}/layout`
- 请求：
```json
{"color":"white","widthPx":390,"heightPx":567,"dpi":300,"kb":200}
```
- 响应：
```json
{"taskId":"...","layout":"6inch","url":"...","status":"done"}
```

## 8. 下载
### 8.1 下载信息
- `GET /api/download/{id}`
- 响应：
```json
{"taskId":"...","urls":{"white":"...","blue":"..."},"expiresIn":600}
```

### 8.2 下载授权
- `POST /api/download/token`
- 请求：
```json
{"taskId":"...","ttlSeconds":600}
```
- 响应：
```json
{"token":"...","expiresAt":"..."}
```

### 8.3 下载文件流
- `GET /api/download/file?token=...`
- 响应：文件流或 zip

## 9. 订单
### 9.1 创建订单
- `POST /api/orders`
- 请求：
```json
{"taskId":"...","items":[{"type":"print","qty":1}],"city":"上海","remark":"测试","amountCents":990,"channel":"wechat"}
```
- 响应：Order

### 9.2 订单列表
- `GET /api/orders`
- Query：`page` `pageSize`
- 响应：
```json
{"items":[...],"page":1,"pageSize":20,"total":1}
```

### 9.3 订单详情
- `GET /api/orders/{id}`
- 响应：Order

## 10. 支付
### 10.1 微信支付
- `POST /api/pay/wechat`
- 请求：
```json
{"orderId":"...","openid":"..."}
```
- 响应：
```json
{"orderId":"...","payParams":{"appId":"...","timeStamp":"...","nonceStr":"...","package":"prepay_id=...","signType":"RSA","paySign":"..."}}
```
- 说明：
  - `openid` 可由登录态获取，前端未携带时后端会从 Token 解析。
  - `notify_url` 配置为：`https://{你的域名}/api/pay/wechat/notify`

### 10.2 抖音支付（mock）
- `POST /api/pay/douyin`
- 请求：
```json
{"orderId":"..."}
```
- 响应：mock 支付参数

### 10.3 微信支付回调
- `POST /api/pay/wechat/notify`
- 由微信支付回调，请勿前端调用

## 11. ZJZ 代理接口
### 11.1 规格列表
- `POST /api/zjz/item/list`
- 响应：ZJZ item 列表

### 11.2 规格详情
- `POST /api/zjz/item/get`
- 请求：
```json
{"itemId":1}
```
- 响应：ZJZ item 详情

### 11.3 回执照制作
- `POST /api/zjz/receipt/make`
- 请求：
```json
{"itemId":1,"imageBase64":"...","sourceObjectKey":"uploads/xxx.jpg"}
```
- 说明：`imageBase64` 或 `sourceObjectKey` 二选一

### 11.4 回执照提交
- `POST /api/zjz/receipt/submit`
- 请求：
```json
{"picId":"...","noticeUrl":"https://...","param":"..."}
```

### 11.5 回执照异步通知
- `POST /api/zjz/receipt/notify`
- Content-Type：`application/x-www-form-urlencoded`
- 响应：
```json
{"ok":true}
```

### 11.6 AI 证件照制作
- `POST /api/zjz/ai-photo/make`
- 请求：
```json
{"templateId":"...","images":["..."],"sourceObjectKeys":["..."],"noticeUrl":"https://..."}
```
- 说明：`images` 或 `sourceObjectKeys` 二选一

### 11.7 AI 模板列表
- `POST /api/zjz/ai-photo/templates`
- 响应：ZJZ 模板列表

### 11.8 AI 异步通知
- `POST /api/zjz/ai-photo/notify`
- Content-Type：`application/x-www-form-urlencoded`
- 响应：
```json
{"ok":true}
```

### 11.9 人脸增强
- `POST /api/zjz/face/enhance`
- 请求：
```json
{"imageBase64":"...","sourceObjectKey":"uploads/xxx.jpg","size":"1024"}
```
- 说明：`imageBase64` 或 `sourceObjectKey` 二选一

### 11.10 账户信息
- `POST /api/zjz/user/info`
- 请求：
```json
{"accessToken":"..."}
```

### 11.11 应用信息
- `POST /api/zjz/user/app`
- 请求：
```json
{"accessToken":"...","key":"..."}
```

## 12. 关键字段说明
- `itemId`：ZJZ 规格 ID（通过 item/list 获取）
- `beauty`：美颜强度（0-100，按 ZJZ 规则）
- `enhance`：增强强度（0-100，按 ZJZ 规则）
- `watermark`：是否走带水印的 ZJZ 接口
