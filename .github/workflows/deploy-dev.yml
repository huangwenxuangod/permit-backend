name: deploy
on:
  push:
    branches:
      - dev
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - run: go mod download
      - run: go vet ./...
      - run: go test ./... -v
      - run: docker build -t permit-backend:ci .
      - name: set-vars
        shell: bash
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then TAG="prod"; else TAG="dev"; fi
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          echo "IMAGE_FULL=${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_REPO }}:$TAG" >> $GITHUB_ENV
          echo "ALGO_IMAGE=${{ secrets.ACR_ALGO_IMAGE }}" >> $GITHUB_ENV
          echo "POSTGRES_IMAGE=${{ secrets.ACR_POSTGRES_IMAGE }}" >> $GITHUB_ENV
          echo "NGINX_IMAGE=${{ secrets.ACR_NGINX_IMAGE }}" >> $GITHUB_ENV
          echo "SRC_ALGO=linzeyi/hivision_idphotos:latest" >> $GITHUB_ENV
          echo "SRC_PG=postgres:16" >> $GITHUB_ENV
          echo "SRC_NGINX=nginx:1.27-alpine" >> $GITHUB_ENV
      - name: login-acr
        run: echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ secrets.ACR_REGISTRY }} -u "${{ secrets.ACR_USERNAME }}" --password-stdin
      - name: sync-deps-images
        shell: bash
        run: |
          docker pull "${{ env.SRC_ALGO }}"
          docker tag "${{ env.SRC_ALGO }}" "${{ env.ALGO_IMAGE }}"
          docker push "${{ env.ALGO_IMAGE }}"
          docker pull "${{ env.SRC_PG }}"
          docker tag "${{ env.SRC_PG }}" "${{ env.POSTGRES_IMAGE }}"
          docker push "${{ env.POSTGRES_IMAGE }}"
          docker pull "${{ env.SRC_NGINX }}"
          docker tag "${{ env.SRC_NGINX }}" "${{ env.NGINX_IMAGE }}"
          docker push "${{ env.NGINX_IMAGE }}"
      - name: push-image
        run: |
          docker tag permit-backend:ci "${{ env.IMAGE_FULL }}"
          docker push "${{ env.IMAGE_FULL }}"
      - name: upload-compose
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_KEY }}
          source: "docker-compose.yml"
          target: "/srv/permit/"
          overwrite: true
      - name: upload-nginx-conf
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_KEY }}
          source: "nginx/conf.d/permit.conf"
          target: "/srv/permit/"
          overwrite: true
      - name: deploy-ecs
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_KEY }}
          script: |
            docker login ${{ secrets.ACR_REGISTRY }} -u "${{ secrets.ACR_USERNAME }}" -p "${{ secrets.ACR_PASSWORD }}"
            mkdir -p /srv/permit
            cat >/srv/permit/.env <<EOF
            PERMIT_JWT_SECRET=${{ secrets.JWT_SECRET }}
            PERMIT_WECHAT_APPID=${{ secrets.PERMIT_WECHAT_APPID }}
            PERMIT_WECHAT_SECRET=${{ secrets.PERMIT_WECHAT_SECRET }}
            PERMIT_WECHAT_MCHID=${{ secrets.PERMIT_WECHAT_MCHID }}
            PERMIT_WECHAT_NOTIFY_URL=${{ secrets.PERMIT_WECHAT_NOTIFY_URL }}
            PERMIT_ASSETS_PUBLIC_URL=${{ secrets.PERMIT_ASSETS_PUBLIC_URL }}
            PERMIT_BACKEND_IMAGE=${{ env.IMAGE_FULL }}
            PERMIT_ALGO_IMAGE=${{ env.ALGO_IMAGE }}
            PERMIT_POSTGRES_IMAGE=${{ env.POSTGRES_IMAGE }}
            PERMIT_NGINX_IMAGE=${{ env.NGINX_IMAGE }}
            EOF
            if docker compose version >/dev/null 2>&1; then
              docker compose pull
              docker compose up -d
              docker compose ps
            else
              docker-compose pull || true
              docker-compose up -d || true
              docker-compose ps || true
            fi
