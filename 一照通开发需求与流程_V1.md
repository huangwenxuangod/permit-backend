# 一照通开发需求与流程（V1）

## 项目概述
- 目标：为用户快速生成符合各类证件规格的标准证件照，支持拍摄/选择原图、自动处理、预览与下载
- 人群与渠道：微信小程序为主，H5 开发环境调试；后续可扩展到抖音等
- 范围：V1 闭环为“选择规格→拍摄指引→上传/拍摄→检测/处理→预览（背景/美颜/增强/排版）→订单确认→支付→下载/交付”。回执能力可预留集成

## 平台与技术
- 前端：Taro + React（Weapp/H5），入口页为 pages/index/index
- 后端：Go 服务（/api），与 Python 算法服务（HivisionIDPhotos）对接
- 存储：本地 data + /assets 开发直链；生产建议对象存储与签名下载
- 认证：开发阶段可放宽；生产阶段采用 JWT 鉴权

## V1 功能清单
- 规格获取：展示可选规格及默认参数（宽高、DPI、可选背景）
- 上传原图：支持 jpg/png/webp；返回 objectKey
- 创建任务：按规格与选色处理原图（V1 同步返回结果）
- 预览下载：展示 processedUrls，开发模式可直接访问 /assets
- 订单确认：展示商品组合（如“照片回执+电子照”“排版照 x1”）、价格、折扣、办理城市与备注
- 支付与回调：创建订单、下单（微信/抖音）、支付回调验签与幂等、更新订单状态
- 错误与提示：统一错误体，用户可重试
- 日志与追踪：生成 requestId 并贯穿前后端

## 端到端流程
- 用户：选择规格 → 拍摄指引 → 相册选取/拍摄 → 检测与处理进度 → 相片预览（背景/美颜/增强/排版）→ 订单确认 → 支付 → 下载/交付
- 前端：/api/specs → /api/upload（multipart）→ /api/tasks（JSON）→ 订单创建与支付 → /api/download/{taskId}
- 后端：接收上传 → 触发算法处理 → 产物入库/落盘 → 返回 processedUrls
- 算法服务：人像分割 → 背景替换 → 规格裁切与 DPI 设置 → 返回图片数据

## 接口契约
- 参考：[API对接文档_V1.md](file:///d:/dev/one-permit/permit-backend/API对接文档_V1.md)
- 已定义端点：/api/specs、/api/upload、/api/tasks、/api/tasks/{id}、/api/download/{taskId}
- 订单与支付（纳入 V1）：/api/orders（创建订单）、/api/pay/wechat、/api/pay/douyin（下单）、/api/pay/callback（支付回调）
- 下载授权（预留）：/api/download/token（生产签名下载）

## 核心数据模型（V1）
- PhotoTask：id、userId、specCode、sourceObjectKey、status、processedUrls、createdAt、updatedAt
- PhotoAsset：taskId、color、url（或 objectKey）、meta（尺寸/DPI/质量）
- DownloadToken（预留）：token、taskId、expiresAt、status
- Order：orderId、taskId、items（electronic/layout/receipt）、city、remark、amountCents、channel、status（created/pending/paid/canceled/refunded）、createdAt、updatedAt
- PayRecord：orderId、channel、idempotencyKey、status、callbackRaw、signature_ok、createdAt

## 规格与图像要求
- 输入限制：格式 jpg/png/webp；最大大小（建议 ≤ 10MB）；最小分辨率（建议 ≥ 1000px 边）
- EXIF 与旋转：自动识别并矫正；若无法矫正需提示
- 背景与裁切：支持 white/blue/red；按规格裁切到 widthPx/heightPx 与 DPI 设置
- 默认参数：若前端未传 widthPx/heightPx/dpi，后端按 specCode 默认值处理

## 订单确认（页面与交互）
- 商品与权益：展示“照片回执+电子照”“排版照 x1”等组合；支持折扣展示与“交易保障”标签
- 办理城市：必填项（与回执办理相关），城市选择器
- 备注：可选文本输入
- 价格与合计：展示原价、优惠价、最终合计；灰置不可用项
- 操作：立即支付；失败时高亮错误与重试入口

## 订单与支付流程
- 创建订单：POST /api/orders
  - 请求：{ taskId, items: [{type:'electronic',qty:1},{type:'layout',qty:1},{type:'receipt',qty:1?}], city, remark, amountCents, channel }
  - 响应：{ orderId, status:'created' }
- 下单支付：POST /api/pay/wechat 或 /api/pay/douyin
  - 请求：{ orderId, Idempotency-Key }
  - 响应：{ orderId, payParams:{ ...channel-specific... } }
- 支付回调：POST /api/pay/callback
  - 行为：验签、幂等、更新订单状态为 paid/pending；原始 payload 入库（signature_ok 标记）
- 交付：成功后提供下载（签名下载预留）与回执办理引导；回执集成可通过第三方接口（如 zjzapi）在 V2 打通

## 非功能要求
- 性能与体验：同步处理成功响应 ≤ 3s（典型图）；失败明确错误信息
- 限流与网关：开发阶段可放宽，生产阶段按用户/设备限流与防刷
- 幂等与回调：支付/回调携带 Idempotency-Key；回调原始 payload 入库并验签
- 日志与监控：统一 requestId、错误码集合、基本指标（成功率/耗时/失败原因）

## 安全与隐私
- 认证：JWT，Authorization: Bearer <token>
- 下载：生产采用签名下载与短 TTL token；绑定用户/订单并可一次性
- 隐私：资源保留与清理策略（如 7-30 天），用户主动删除路径

## 环境与配置
- 前端：TARO_APP_ID（小程序 AppID）、API_BASE_URL（H5 调试代理或直连）
- 后端：HTTP_PORT、POSTGRES_DSN（预留）、AI_SERVICE_URL、JWT_SECRET、ASSETS_DIR
- 小程序白名单：API 域名、上传域名、下载/资源域名需加入业务域名配置

## 验收标准（V1）
- 能完成规格选择、上传、生成、预览、订单确认、支付与下载闭环
- 生成图片满足规格尺寸与 DPI；至少白/蓝两种背景
- 订单页面包含商品组合、城市选择、备注、合计与“立即支付”；支付成功后状态更新
- 失败有明确错误体与提示文案；可重试
- 文档与接口一致；字段命名统一（specCode、objectKey、processedUrls 等）

## 里程碑
- M1：规格与上传联调完成，返回 objectKey
- M2：任务生成与预览完成，processedUrls 可用
- M3：订单确认页完成，订单创建与支付打通，支付回调入库
- M4：下载与验收通过，错误集合与日志完善；签名下载与回执集成预留端点

## 待确认问题清单
- 认证策略：V1 是否允许未登录上传与生成？登录态何时启用强校验？
- 处理模式：任务采用同步返回还是改为“入队 + 轮询/订阅”？若改异步，约定轮询/超时策略
- 规格来源：规格默认值（毫米/像素/DPI、头肩占比等）是否由后端统一提供？
- 上传限制：格式、大小、最小分辨率、超时与重试策略，前端是否需本地预检查？
- 产物规范：输出类型（jpg/png）、DPI、压缩质量、是否提供排版模板与打包 zip
- 下载授权：token TTL、一次性与否、是否绑定用户/订单、签名算法与资源域名
- 支付范围：优先集成渠道（微信/抖音）、下单参数、验签算法、幂等键来源与冲突处理
- 网关与限流：是否在文档中固化 X-Request-Id、Idempotency-Key、X-Api-Client 等统一 Header？
- 国际化：错误 message 语言策略（后端返回 code，前端映射文案或直接中文）
- 隐私与清理：资源保留周期、用户删除、合规要求（如数据最小化）

## 参考
- API 契约与示例：[API对接文档_V1.md](file:///d:/dev/one-permit/permit-backend/API对接文档_V1.md)
- 前端对接指南：[API对接指南_V1.md](file:///d:/dev/one-permit/permit-frontend/API对接指南_V1.md)
